# RBAC Admin Pro 部署指南

## 目录

- [环境要求](#环境要求)
- [快速部署（Docker Compose）](#快速部署docker-compose)
- [手动部署](#手动部署)
- [生产环境配置](#生产环境配置)
- [常见问题](#常见问题)

---

## 环境要求

| 组件 | 版本要求 |
|------|----------|
| Node.js | >= 20.x |
| pnpm | >= 9.x |
| PostgreSQL | >= 16 |
| Redis | >= 7 (可选) |
| Docker | >= 20.x (Docker 部署) |
| Docker Compose | >= 2.x (Docker 部署) |

---

## 快速部署（Docker Compose）

推荐使用 Docker Compose 一键部署，包含 PostgreSQL、Redis、后端服务和前端服务。

### 1. 准备环境变量

```bash
# 复制环境变量模板
cp .env.docker.example .env.docker

# 编辑配置（必须修改密码和密钥）
vim .env.docker
```

`.env.docker` 配置示例：

```bash
# 数据库配置
POSTGRES_DB=rbac_admin_pro
POSTGRES_USER=rbac_admin
POSTGRES_PASSWORD=YourStrongPassword@2024  # 请修改为强密码

# JWT 密钥（生产环境必须修改）
# 生成方法: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
JWT_SECRET=your-super-secret-key-change-it-in-production
```

### 2. 启动服务

```bash
# 启动所有服务
docker-compose --env-file .env.docker up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 3. 访问系统

| 服务 | 地址 |
|------|------|
| 前端 | http://localhost |
| 后端 API | http://localhost:3000 |
| API 文档 | http://localhost:3000/api-docs |

默认账号：`admin` / `admin123`

### 4. 停止服务

```bash
# 停止服务
docker-compose down

# 停止并删除数据卷（慎用，会清除数据）
docker-compose down -v
```

---

## 手动部署

适用于需要更灵活配置的场景。

### 1. 数据库准备

#### 1.1 安装 PostgreSQL

```bash
# macOS
brew install postgresql@16

# Ubuntu/Debian
sudo apt install postgresql-16

# 启动服务
brew services start postgresql@16  # macOS
sudo systemctl start postgresql    # Linux
```

#### 1.2 创建数据库和用户

```bash
# 进入 PostgreSQL
psql -U postgres

# 执行以下 SQL
CREATE USER rbac_admin WITH PASSWORD 'RbacAdmin@2024';
CREATE DATABASE rbac_admin_pro OWNER rbac_admin;
GRANT ALL PRIVILEGES ON DATABASE rbac_admin_pro TO rbac_admin;
\q
```

#### 1.3 初始化数据库

```bash
# 导入表结构
psql -U rbac_admin -d rbac_admin_pro -f db/schema.sql

# 导入初始数据
psql -U rbac_admin -d rbac_admin_pro -f db/init_data.sql
```

### 2. Redis 准备（可选）

开发环境可跳过，系统会使用内存模式。生产环境建议启用。

```bash
# macOS
brew install redis
brew services start redis

# Ubuntu/Debian
sudo apt install redis-server
sudo systemctl start redis
```

### 3. 后端部署

#### 3.1 安装依赖

```bash
cd server-nestjs
pnpm install
```

#### 3.2 配置环境变量

```bash
cp .env.example .env
vim .env
```

关键配置项：

```bash
# 应用配置
PORT=3000
NODE_ENV=production

# 数据库连接
DATABASE_URL="postgresql://rbac_admin:RbacAdmin@2024@localhost:5432/rbac_admin_pro?schema=public"

# JWT 密钥（生产环境必须修改）
JWT_SECRET=your-super-secret-key-change-it

# Redis（生产环境建议启用）
REDIS_ENABLED=true
REDIS_URL=redis://127.0.0.1:6379

# CORS（生产环境必须配置）
CORS_ORIGINS=https://your-domain.com
```

#### 3.3 生成 Prisma Client

```bash
pnpm prisma generate
```

#### 3.4 启动服务

```bash
# 开发模式
pnpm start:dev

# 生产模式
pnpm build
pnpm start:prod
```

### 4. 前端部署

#### 4.1 安装依赖

```bash
cd web
pnpm install
```

#### 4.2 配置 API 地址

编辑 `web/vite.config.ts`，修改代理配置：

```typescript
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:3000',  // 后端地址
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/api/, '')
    }
  }
}
```

#### 4.3 构建

```bash
# 开发模式
pnpm dev

# 生产构建
pnpm build
```

#### 4.4 部署静态文件

将 `dist` 目录部署到 Nginx 或其他 Web 服务器。

Nginx 配置示例：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json;

    root /var/www/rbac-admin/dist;
    index index.html;

    # SPA 路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API 代理
    location /api/ {
        proxy_pass http://127.0.0.1:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
```

---

## 生产环境配置

### 安全配置清单

| 配置项 | 说明 | 位置 |
|--------|------|------|
| `POSTGRES_PASSWORD` | 数据库密码，使用强密码 | `.env.docker` |
| `JWT_SECRET` | JWT 签名密钥，至少 32 位随机字符串 | 后端 `.env` |
| `CORS_ORIGINS` | 允许的跨域来源，配置实际域名 | 后端 `.env` |
| `NODE_ENV` | 设置为 `production` | 后端 `.env` |
| `ERROR_FULL` | 生产环境设为 `false` | 后端 `.env` |

### 生成安全密钥

```bash
# 生成 JWT 密钥
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# 生成数据库密码
node -e "console.log(require('crypto').randomBytes(16).toString('base64'))"
```

### HTTPS 配置

生产环境强烈建议启用 HTTPS：

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/nginx/ssl/your-domain.crt;
    ssl_certificate_key /etc/nginx/ssl/your-domain.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # ... 其他配置同上
}

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

### 数据备份

```bash
# 备份数据库
docker exec rbac-postgres pg_dump -U rbac_admin rbac_admin_pro > backup_$(date +%Y%m%d).sql

# 恢复数据库
docker exec -i rbac-postgres psql -U rbac_admin rbac_admin_pro < backup_20241210.sql
```

---

## 常见问题

### 1. 数据库连接失败

检查 `DATABASE_URL` 格式，特殊字符需 URL 编码：
- `@` → `%40`
- `:` → `%3A`
- `/` → `%2F`

### 2. 前端无法访问 API

- 检查 `CORS_ORIGINS` 是否配置正确
- 检查 Nginx 代理配置
- 确认后端服务正常运行

### 3. Redis 连接失败

开发环境可设置 `REDIS_ENABLED=false` 使用内存模式。

### 4. Docker 容器启动失败

```bash
# 查看详细日志
docker-compose logs server
docker-compose logs postgres

# 重新构建镜像
docker-compose build --no-cache
```

### 5. 健康检查失败

确保后端 `/health` 接口可访问：

```bash
curl http://localhost:3000/health
```

---

## 服务端口说明

| 服务 | 端口 | 说明 |
|------|------|------|
| 前端 (Nginx) | 80 | Web 界面 |
| 后端 (NestJS) | 3000 | REST API |
| PostgreSQL | 5432 | 数据库 |
| Redis | 6379 | 缓存 |

---

## Docker 常用命令

### 服务管理

```bash
# 启动所有服务
docker-compose up -d

# 启动指定服务
docker-compose up -d postgres redis

# 重启服务
docker-compose restart server

# 查看运行状态
docker-compose ps

# 查看资源使用
docker stats
```

### 日志查看

```bash
# 查看所有日志
docker-compose logs

# 实时跟踪指定服务
docker-compose logs -f server

# 查看最近 100 行
docker-compose logs --tail=100 server
```

### 容器操作

```bash
# 进入容器 Shell
docker-compose exec server sh

# 进入数据库
docker-compose exec postgres psql -U rbac_admin -d rbac_admin_pro
```

### 镜像管理

```bash
# 重新构建镜像
docker-compose build

# 不使用缓存构建
docker-compose build --no-cache
```

---

## 更新部署

### 代码更新

```bash
# 拉取最新代码
git pull origin main

# 重新构建并启动
docker-compose build
docker-compose up -d
```

### 数据库迁移

```bash
# 进入容器执行迁移
docker-compose exec server pnpm prisma migrate deploy
```

---

## 生产环境建议

### 日志轮转

```yaml
# docker-compose.yml
services:
  server:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

### 资源限制

```yaml
services:
  server:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
```

### 自动备份脚本

```bash
#!/bin/bash
# backup.sh
BACKUP_DIR="/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# 备份数据库
docker-compose exec -T postgres pg_dump -U rbac_admin rbac_admin_pro > "$BACKUP_DIR/db_$DATE.sql"

# 删除 7 天前的备份
find "$BACKUP_DIR" -name "*.sql" -mtime +7 -delete
```

设置定时任务：
```bash
# 每天凌晨 2 点备份
0 2 * * * /path/to/backup.sh
```

---

**最后更新**: 2025-12-10
