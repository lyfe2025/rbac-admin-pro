# 项目脚本使用指南

本项目在根目录提供 Shell 脚本：`monorepo.sh`，用于快速执行 Monorepo 的常用操作。脚本支持一键启动/停止/重启前后端、状态查询，并具备前台日志跟随与动态端口解析能力。

## 运行方式

- 交互式：

```
bash monorepo.sh
```

- 查看菜单（非交互）：

```
bash monorepo.sh --list
```

- 直接执行指定动作（非交互）：

```
bash monorepo.sh --action 1  # 一键启动 前端+后端并跟随日志
bash monorepo.sh --action 2  # 一键停止 前端+后端
bash monorepo.sh --action 3  # 一键重启 前端+后端并跟随日志
```

提示：选择带日志跟随的动作时，按 `Ctrl+C` 退出日志跟随（服务仍在后台运行）。

## 菜单项说明（最新）

1. 一键启动 前端+后端（后台运行并写入 pid，自动跟随日志）
2. 一键停止 前端+后端（优先按 pid 停止，端口兜底）
3. 一键重启 前端+后端（停止后重新启动并跟随日志）
4. 同步数据库迁移（`npx prisma migrate dev`）
5. 打开 Prisma Studio（`npx prisma studio`）
6. 前端类型检查（`npm run type-check`）
7. 后端代码校验（`npm run validate`）
8. 后端快速 API 冒烟测试（依次执行 `test-*.sh`）

## 端口解析说明

- 前端端口来源：按顺序读取 `web/.env.development.local` → `web/.env.development` → `web/.env.local` → `web/.env` 的 `VITE_PORT`，若未设置则默认 `5173`。
- 后端端口来源：按顺序读取 `server-nestjs/.env.local` → `server-nestjs/.env` 的 `PORT`，若未设置则默认 `3000`。
- 脚本启动/重启前会先释放对应端口占用；如你手动在终端运行了服务，脚本可能会终止该进程以便重新启动。

覆盖方式：运行时可通过环境变量覆盖端口，无需改配置文件；状态在菜单头部始终可见，无需单独查看动作。

```
WEB_PORT=6000 SERVER_PORT=3100 bash monorepo.sh --action 1
```

## 日志与文件位置

- pid 文件目录：`/.run`（生成 `web-dev.pid`、`server-dev.pid`）
- 日志文件目录：`/.run`（生成 `web-dev.log`、`server-dev.log`）
- 选择带日志跟随的动作会执行 `tail -f`，退出跟随请按 `Ctrl+C`；服务不会随之退出。
- 菜单头部会显示：服务状态、pid、端口、进程时长（uptime）、最新日志时间（log）、端口来源（source）。
- 菜单头部分为“前端”和“后端”两个信息块，分别显示：状态、pid、端口（含来源）、uptime（“x 小时 y 分钟”）、日志位置（最近两级路径）。

## 扩展建议

- 可按需新增更多动作，例如：前端构建、后端单元测试等。
- 如需在 CI 中使用，推荐统一采用 `--action` 非交互模式。
# 🧰 脚本使用指南（含 Redis 配置）

## 环境变量
- 后端环境文件路径：`server-nestjs/.env`
- 关键项：
  - `DATABASE_URL`：PostgreSQL 连接串
  - `JWT_SECRET`：JWT 密钥
  - `JWT_EXPIRES_IN`：JWT 过期时间（支持 `s/m/h/d`，如 `24h`、`7d`）
  - `REDIS_URL`：Redis 连接串，例如 `redis://127.0.0.1:6379`

示例：
```
DATABASE_URL="postgresql://rbac_admin:RbacAdmin@2024@localhost:5432/rbac_admin_pro?schema=public"
JWT_SECRET=super-secret-key-change-it
JWT_EXPIRES_IN=24h
REDIS_URL=redis://127.0.0.1:6379
```

修改 `.env` 后需重启后端：
- 在 `server-nestjs` 目录运行：`npm run start:dev`

## 常用验证命令
- 登录获取 Token：
```
curl -s -X POST http://localhost:3000/auth/login \
  -H 'Content-Type: application/json' \
  -d '{"username":"admin","password":"123456"}'
```
- 查询在线用户（需 `Authorization`）：
```
curl -s 'http://localhost:3000/monitor/online?pageNum=1&pageSize=10' \
  -H "Authorization: Bearer <token>"
```
- 退出（将 Token 加入黑名单并移除在线）：
```
curl -s -X POST http://localhost:3000/auth/logout \
  -H "Authorization: Bearer <token>"
```
