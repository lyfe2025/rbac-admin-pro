# 项目规则更新说明

> 更新时间: 2024-12-05 07:00  
> 更新内容: 补充错误码规范和日志使用规范

---

## 📋 更新内容

### 1. 后端架构规范增强

在 `⚙️ 后端规范 (Server) > 🧱 架构与分层` 中补充:

#### Controller 层
- ✅ 必须添加 Swagger 装饰器: `@ApiTags()`, `@ApiOperation()`, `@ApiBearerAuth()`

#### Service 层
- ✅ **必须使用** `LoggerService` 记录关键操作日志
- ✅ **必须使用** `BusinessException` 抛出业务异常

#### DTO 层
- ✅ 必须添加 JSDoc 注释 (如 `/** 用户名 */`)，Swagger 插件会自动生成文档

### 2. 新增错误码规范章节

新增 `🚨 错误码规范 (必须遵守)` 章节，包含:

#### 后端错误处理
1. **导入方式**:
   ```typescript
   import { BusinessException } from '@/common/exceptions';
   import { ErrorCode } from '@/common/enums';
   ```

2. **抛出异常的3种方式**:
   - 使用错误码
   - 自定义消息
   - 使用静态工厂方法

3. **常见场景示例**:
   - 数据不存在
   - 数据已存在
   - 参数错误
   - 权限不足
   - 未登录
   - 操作被拒绝

4. **错误码分类**:
   - `1xxxx`: 通用错误
   - `2xxxx`: 认证授权
   - `3xxxx`: 用户管理
   - `4xxxx`: 角色管理
   - `5xxxx`: 部门管理
   - `6xxxx`: 菜单管理
   - `7xxxx`: 字典/岗位管理
   - `8xxxx`: 系统配置
   - `9xxxx`: 监控日志

#### 前端错误处理
1. **导入方式**
2. **响应拦截器处理**
3. **组件中处理特定错误**

### 3. 新增日志使用规范章节

新增 `📝 日志使用规范 (必须遵守)` 章节，包含:

#### 后端日志
1. **导入日志服务**
2. **日志级别使用**:
   - `DEBUG`: 调试信息 (开发环境)
   - `INFO`: 一般信息
   - `WARN`: 警告信息 (业务异常)
   - `ERROR`: 错误信息 (系统异常)

3. **日志记录时机**:
   - **必须记录**: 关键业务操作、外部服务调用、数据库操作失败、权限验证失败
   - **建议记录**: 复杂业务逻辑的关键步骤、性能敏感操作的耗时
   - **不要记录**: 简单的查询操作、密码等敏感信息

4. **日志格式规范**: 提供好的和不好的示例

#### 前端日志
- 使用 `console.log/warn/error` 进行调试
- 生产环境应移除或使用日志库统一管理
- **严禁**提交包含 `console.log` 的代码到生产环境

### 4. AI 协作指南增强

在 `🤖 AI 协作指南 (For Trae)` 中新增第5条:

**错误码和日志 (强制要求)**:
- **后端 Service**: 必须使用 `BusinessException` 抛出业务异常，禁止使用 `throw new Error()`
- **后端 Service**: 必须使用 `LoggerService` 记录关键操作，禁止使用 `console.log`
- **后端 Controller**: 必须添加 Swagger 装饰器
- **后端 DTO**: 必须添加 JSDoc 注释
- **前端**: 使用错误码进行特定错误处理，避免硬编码错误消息

### 5. 核心经验与强约束增强

在 `🔒 核心经验与强约束（精简版）` 中新增:
- **后端 Service 必须**: 使用 `BusinessException` + `LoggerService`，禁止 `throw new Error()` 和 `console.log`
- **后端 Controller 必须**: 添加 Swagger 装饰器
- **后端 DTO 必须**: 添加 JSDoc 注释

---

## 🎯 规范要点总结

### 后端开发必须遵守

#### ✅ Service 层
```typescript
import { Injectable } from '@nestjs/common';
import { LoggerService } from '@/common/logger/logger.service';
import { BusinessException } from '@/common/exceptions';
import { ErrorCode } from '@/common/enums';

@Injectable()
export class UserService {
  constructor(
    private prisma: PrismaService,
    private logger: LoggerService, // ✅ 必须注入
  ) {}

  async findOne(userId: string) {
    // ✅ 记录关键操作
    this.logger.debug(`查询用户: ${userId}`, 'UserService');
    
    const user = await this.prisma.sysUser.findUnique({
      where: { userId: BigInt(userId) },
    });

    if (!user) {
      // ✅ 使用 BusinessException
      throw new BusinessException(ErrorCode.USER_NOT_FOUND);
    }

    return user;
  }

  async delete(userId: string, currentUserId: string) {
    // ✅ 业务规则验证
    if (userId === currentUserId) {
      throw new BusinessException(ErrorCode.CANNOT_DELETE_SELF);
    }

    // ✅ 记录关键操作
    this.logger.log(`删除用户: ${userId}`, 'UserService');
    
    await this.prisma.sysUser.update({
      where: { userId: BigInt(userId) },
      data: { delFlag: '2' },
    });
  }
}
```

#### ✅ Controller 层
```typescript
import { Controller, Get, Post, Body, Param } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiBearerAuth } from '@nestjs/swagger'; // ✅ 必须导入

@ApiTags('用户管理') // ✅ 必须添加
@ApiBearerAuth('JWT-auth') // ✅ 必须添加
@Controller('system/user')
export class UserController {
  constructor(private userService: UserService) {}

  @Get(':userId')
  @ApiOperation({ summary: '查询用户详情' }) // ✅ 必须添加
  findOne(@Param('userId') userId: string) {
    return this.userService.findOne(userId);
  }
}
```

#### ✅ DTO 层
```typescript
import { IsString, IsNotEmpty, IsOptional } from 'class-validator';

/**
 * 创建用户 DTO
 */
export class CreateUserDto {
  /** 用户账号 */ // ✅ 必须添加 JSDoc 注释
  @IsString()
  @IsNotEmpty()
  userName: string;

  /** 用户昵称 */ // ✅ 必须添加
  @IsString()
  @IsNotEmpty()
  nickName: string;

  /** 邮箱地址 */ // ✅ 必须添加
  @IsOptional()
  @IsString()
  email?: string;
}
```

### 前端开发建议

#### ✅ 错误处理
```typescript
import { ErrorCode, shouldRedirectToLogin } from '@/types/error-code'

// 在响应拦截器中
axios.interceptors.response.use(
  (response) => {
    const { code, msg } = response.data
    
    // ✅ 使用错误码判断
    if (shouldRedirectToLogin(code)) {
      router.push('/login')
      return Promise.reject(new Error(msg))
    }
    
    return response.data
  }
)

// 在组件中
async function handleDelete(userId: string) {
  try {
    await deleteUser(userId)
  } catch (error: any) {
    // ✅ 根据错误码做特殊处理
    if (error.code === ErrorCode.CANNOT_DELETE_SELF) {
      toast({ title: '不能删除当前登录用户' })
    }
  }
}
```

---

## 📚 相关文档

- [错误码规范化完成总结](./错误码规范化完成总结.md)
- [Swagger自动生成配置](../后端/Swagger自动生成配置.md)
- [项目优化TODO清单](./项目优化TODO清单.md)

---

## ⚠️ 重要提醒

### 对于 AI (Trae)
从现在开始，在编写或修改代码时:
1. ✅ **必须**使用 `BusinessException` 抛出业务异常
2. ✅ **必须**使用 `LoggerService` 记录关键操作
3. ✅ **必须**为 Controller 添加 Swagger 装饰器
4. ✅ **必须**为 DTO 添加 JSDoc 注释
5. ❌ **禁止**使用 `throw new Error()`
6. ❌ **禁止**使用 `console.log`

### 对于开发者
- 新代码必须遵守以上规范
- 旧代码可以逐步重构
- 代码审查时检查是否符合规范

---

**项目规则已更新!** 🎉  
请所有开发者和 AI 助手严格遵守新的规范。

**最后更新**: 2024-12-05 07:00
