# 操作日志和登录历史功能

## 当前状态
- ✅ 前端UI已预留标签页
- ⏳ 后端接口待实现
- ⏳ 前端数据展示待实现

---

## 1. 操作日志功能

### 后端实现

#### 1.1 数据库表设计
```sql
-- 操作日志表
CREATE TABLE sys_oper_log (
  oper_id BIGSERIAL PRIMARY KEY,
  title VARCHAR(50),           -- 操作模块
  business_type INT,            -- 业务类型(0其它 1新增 2修改 3删除)
  method VARCHAR(100),          -- 方法名称
  request_method VARCHAR(10),   -- 请求方式
  operator_type INT,            -- 操作类别(0其它 1后台用户 2手机端用户)
  oper_name VARCHAR(50),        -- 操作人员
  dept_name VARCHAR(50),        -- 部门名称
  oper_url VARCHAR(255),        -- 请求URL
  oper_ip VARCHAR(128),         -- 主机地址
  oper_location VARCHAR(255),   -- 操作地点
  oper_param VARCHAR(2000),     -- 请求参数
  json_result VARCHAR(2000),    -- 返回参数
  status INT,                   -- 操作状态(0正常 1异常)
  error_msg VARCHAR(2000),      -- 错误消息
  oper_time TIMESTAMP,          -- 操作时间
  cost_time BIGINT              -- 消耗时间
);
```

#### 1.2 后端接口

**Controller:** `server-nestjs/src/monitor/operlog/operlog.controller.ts`

```typescript
@Get('list')
@ApiOperation({ summary: '查询操作日志列表' })
async list(@Query() query: QueryOperLogDto) {
  return this.operLogService.findAll(query);
}

@Get(':operId')
@ApiOperation({ summary: '查询操作日志详情' })
async getInfo(@Param('operId') operId: string) {
  return this.operLogService.findOne(operId);
}

@Delete(':operIds')
@ApiOperation({ summary: '删除操作日志' })
async remove(@Param('operIds') operIds: string) {
  return this.operLogService.remove(operIds.split(','));
}

@Delete('clean')
@ApiOperation({ summary: '清空操作日志' })
async clean() {
  return this.operLogService.clean();
}
```

**Service:** `server-nestjs/src/monitor/operlog/operlog.service.ts`

```typescript
// 查询操作日志列表
async findAll(query: QueryOperLogDto) {
  const { title, operName, businessType, status, pageNum = 1, pageSize = 10 } = query;
  
  const where: any = {};
  if (title) where.title = { contains: title };
  if (operName) where.operName = { contains: operName };
  if (businessType !== undefined) where.businessType = businessType;
  if (status !== undefined) where.status = status;

  const [rows, total] = await Promise.all([
    this.prisma.sysOperLog.findMany({
      where,
      skip: (pageNum - 1) * pageSize,
      take: pageSize,
      orderBy: { operTime: 'desc' },
    }),
    this.prisma.sysOperLog.count({ where }),
  ]);

  return { total, rows };
}

// 记录操作日志(拦截器中调用)
async create(operLog: CreateOperLogDto) {
  await this.prisma.sysOperLog.create({
    data: operLog,
  });
}
```

#### 1.3 操作日志拦截器

**Interceptor:** `server-nestjs/src/common/interceptors/oper-log.interceptor.ts`

```typescript
@Injectable()
export class OperLogInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const request = context.switchToHttp().getRequest();
    const startTime = Date.now();

    return next.handle().pipe(
      tap(() => {
        // 记录成功的操作
        this.saveOperLog(context, startTime, 0, null);
      }),
      catchError((error) => {
        // 记录失败的操作
        this.saveOperLog(context, startTime, 1, error.message);
        throw error;
      }),
    );
  }

  private async saveOperLog(context, startTime, status, errorMsg) {
    // 保存操作日志到数据库
  }
}
```

### 前端实现

#### 1.4 API接口

**文件:** `web/src/api/monitor/operlog.ts`

```typescript
export function listOperLog(query: any) {
  return request({
    url: '/monitor/operlog/list',
    method: 'get',
    params: query
  })
}

export function getOperLog(operId: string) {
  return request({
    url: `/monitor/operlog/${operId}`,
    method: 'get'
  })
}
```

#### 1.5 用户详情中的操作日志

**文件:** `web/src/components/business/UserDetailDialog.vue`

```vue
<script setup>
import { ref, watch } from 'vue'
import { listOperLog } from '@/api/monitor/operlog'

const operLogs = ref([])
const loading = ref(false)

// 监听用户变化,加载操作日志
watch(() => props.user, async (newUser) => {
  if (newUser) {
    loading.value = true
    try {
      const res = await listOperLog({
        operName: newUser.userName,
        pageNum: 1,
        pageSize: 10
      })
      operLogs.value = res.rows
    } finally {
      loading.value = false
    }
  }
}, { immediate: true })
</script>

<template>
  <TabsContent value="operlog">
    <ScrollArea class="h-[400px] rounded-md border">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>操作模块</TableHead>
            <TableHead>操作时间</TableHead>
            <TableHead>状态</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          <TableRow v-for="log in operLogs" :key="log.operId">
            <TableCell>{{ log.title }}</TableCell>
            <TableCell>{{ formatDate(log.operTime) }}</TableCell>
            <TableCell>
              <Badge :variant="log.status === 0 ? 'default' : 'destructive'">
                {{ log.status === 0 ? '成功' : '失败' }}
              </Badge>
            </TableCell>
          </TableRow>
          <TableRow v-if="operLogs.length === 0">
            <TableCell colspan="3" class="text-center text-muted-foreground">
              暂无操作日志
            </TableCell>
          </TableRow>
        </TableBody>
      </Table>
    </ScrollArea>
  </TabsContent>
</template>
```

---

## 2. 登录历史功能

### 后端实现

#### 2.1 数据库表设计
```sql
-- 登录日志表
CREATE TABLE sys_logininfor (
  info_id BIGSERIAL PRIMARY KEY,
  user_name VARCHAR(50),        -- 用户账号
  ipaddr VARCHAR(128),          -- 登录IP地址
  login_location VARCHAR(255),  -- 登录地点
  browser VARCHAR(50),          -- 浏览器类型
  os VARCHAR(50),               -- 操作系统
  status CHAR(1),               -- 登录状态(0成功 1失败)
  msg VARCHAR(255),             -- 提示消息
  login_time TIMESTAMP          -- 访问时间
);
```

#### 2.2 后端接口

**Controller:** `server-nestjs/src/monitor/logininfor/logininfor.controller.ts`

```typescript
@Get('list')
@ApiOperation({ summary: '查询登录日志列表' })
async list(@Query() query: QueryLoginInforDto) {
  return this.loginInforService.findAll(query);
}
```

**Service:** `server-nestjs/src/monitor/logininfor/logininfor.service.ts`

```typescript
async findAll(query: QueryLoginInforDto) {
  const { userName, ipaddr, status, pageNum = 1, pageSize = 10 } = query;
  
  const where: any = {};
  if (userName) where.userName = { contains: userName };
  if (ipaddr) where.ipaddr = { contains: ipaddr };
  if (status) where.status = status;

  const [rows, total] = await Promise.all([
    this.prisma.sysLogininfor.findMany({
      where,
      skip: (pageNum - 1) * pageSize,
      take: pageSize,
      orderBy: { loginTime: 'desc' },
    }),
    this.prisma.sysLogininfor.count({ where }),
  ]);

  return { total, rows };
}

// 记录登录日志
async create(loginInfor: CreateLoginInforDto) {
  await this.prisma.sysLogininfor.create({
    data: loginInfor,
  });
}
```

### 前端实现

#### 2.3 API接口

**文件:** `web/src/api/monitor/logininfor.ts`

```typescript
export function listLoginInfor(query: any) {
  return request({
    url: '/monitor/logininfor/list',
    method: 'get',
    params: query
  })
}
```

#### 2.4 用户详情中的登录历史

**文件:** `web/src/components/business/UserDetailDialog.vue`

```vue
<script setup>
const loginLogs = ref([])

watch(() => props.user, async (newUser) => {
  if (newUser) {
    const res = await listLoginInfor({
      userName: newUser.userName,
      pageNum: 1,
      pageSize: 10
    })
    loginLogs.value = res.rows
  }
}, { immediate: true })
</script>

<template>
  <TabsContent value="loginlog">
    <ScrollArea class="h-[400px] rounded-md border">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>登录IP</TableHead>
            <TableHead>登录地点</TableHead>
            <TableHead>浏览器</TableHead>
            <TableHead>登录时间</TableHead>
            <TableHead>状态</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          <TableRow v-for="log in loginLogs" :key="log.infoId">
            <TableCell>{{ log.ipaddr }}</TableCell>
            <TableCell>{{ log.loginLocation }}</TableCell>
            <TableCell>{{ log.browser }}</TableCell>
            <TableCell>{{ formatDate(log.loginTime) }}</TableCell>
            <TableCell>
              <Badge :variant="log.status === '0' ? 'default' : 'destructive'">
                {{ log.status === '0' ? '成功' : '失败' }}
              </Badge>
            </TableCell>
          </TableRow>
          <TableRow v-if="loginLogs.length === 0">
            <TableCell colspan="5" class="text-center text-muted-foreground">
              暂无登录历史
            </TableCell>
          </TableRow>
        </TableBody>
      </Table>
    </ScrollArea>
  </TabsContent>
</template>
```

---

## 实现优先级

### 高优先级
1. ✅ 前端UI占位(已完成)
2. ⏳ 数据库表创建
3. ⏳ 登录日志记录(在登录接口中)
4. ⏳ 登录历史查询接口

### 中优先级
5. ⏳ 操作日志拦截器
6. ⏳ 操作日志查询接口
7. ⏳ 前端数据展示

### 低优先级
8. ⏳ 日志导出功能
9. ⏳ 日志清理功能
10. ⏳ 日志统计分析

---

## 注意事项

1. **性能考虑**
   - 日志表数据量大,需要添加索引
   - 考虑定期归档历史日志
   - 查询时添加时间范围限制

2. **安全考虑**
   - 不记录敏感信息(如密码)
   - 操作参数需要脱敏处理
   - 只有管理员可以查看所有日志

3. **存储优化**
   - 定期清理超过N天的日志
   - 考虑使用日志服务(如ELK)

---

**创建时间:** 2025-12-05  
**状态:** 待实现
